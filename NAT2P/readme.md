# 说明

## 网路

必须进行NAT穿透，所以使用UDP协议。

使用libp2p ![github.com/libp2p/go-reuseport](github.com/libp2p/go-reuseport) 实现收发同端口（注意：可以Listen和Send同一个端口，不能用相同端口发送给相同端口）

## 数据、包（PKG）和块（Block）

### 数据共有5个类型

``` golang
DataType_Reply   成功回报
DataType_Text    文本
DataType_File    文件
DataType_Flow    流
```

### block 数据在发送时会被切分为块（block）后发送。

每一个block的尺寸为`BLOCKSIZE`

block在发送时还会附加`数据ID(sendid)`、`块序号(seq)`、`校验位(check)`，共同组成包（PKG）

### 结束包

发送端发送一个数据完成后，会在末尾追加一个结束包

结束包与普通包的区别是 `seq=0`

接收端通过判断seq是否为0，判断是否收到结束包。

收到结束包后，处理结束块的数据。

结束块包含

1. 最后一个包的序号seq
2. 数据类型
3. 附加数据

- 对于文本类型，附加数据为空
- 对于文件类型，附件数据为文件类型和文件名
- 对于成功回报，附加数据为接收端成功接收的数据ID

结束包不写入到发送缓存和接受缓存，其他包都会写入到缓存以供后续数据处理。

### 成功回报包

成功回报数据只有一包也为结束包

成功回报包因为只有一个结束包，所以不会被写入到收发缓存

成功回报包的块中的附加数据会包含接收方完成接收的数据ID


## 数据接收

接收的结束包后，解析出最大序号、数据类型、附加数据

然后根据包的数据ID、来源地址 查询出所有此数据的包，检查是否完整（根据最后一个seq判断），然后提取所有处理（后续处理）

如果是成功回报，根据附加数据中的数据ID，删除本地发送缓存中的数据。

